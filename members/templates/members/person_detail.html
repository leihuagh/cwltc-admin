{% extends "members/layout.html" %}

{% block content %}
{% load members_extras %}
<style>

.equal, .equal > div[class*='col-'] {  
    display: -webkit-box;
    display: -moz-box;
    display: -ms-flexbox;
    display: -webkit-flex;
    display: flex;
    flex:1 1 auto;
}
</style>

<h3>{{ person.fullname }}</h3>
 
<div class="container">
  <div class="row">
    <div class="col-md-4">
      <div class="panel panel-default">
       <div class="panel-heading">Details</div>
       <div class="panel-body">
           <table>
               <tr><td width="50%">Id:</td><td>{{ person.id }} </td></tr>
               <tr><td>State</td><td>{{ person.state }} </td></tr>
               <tr><td>Date of birth:</td><td>
                   {% if person.dob %}{{ person.dob|date }}
                    {% else %}Unknown{% endif %}
               </td></tr>
               <tr><td>Mobile:</td><td> 
                {% if person.mobile_phone %}{{ person.mobile_phone }} {% else %}No mobile{% endif %}   
                </td></tr>
           </table>
            {% if person.email %}{{ person.email }} {% else %}No email address{% endif %}  
       </div>
       <div class="panel-footer"><a href="{% url "person-edit" pk=person.id %}" class="btn btn-primary btn-sm">Edit details</a></div> 

     </div>
    </div><!--/col-->
    
    <div class="col-md-4">
      <div class="panel panel-default">
       <div class="panel-heading">Address</div>
       <div class="panel-body">
            {{ address.address1 }}<br />
            {% if address.address2 %}{{ address.address2 }}<br />{% endif %}
            {{ address.town }}<br />
            {{ address.post_code }}<br />
            {{ address.home_phone }}
       </div>
       <div class="panel-footer"><a href="{% url "person-address" person_id=person.id %}" class="btn btn-primary btn-sm">Edit address
           </a></div> 
     </div>
    </div><!--/col-->

    <div class="col-md-4">
      <div class="panel panel-default">
       <div class="panel-heading">Family</div>
       <div class="panel-body">
        {% if person.linked %}
            <table width="400">
                <tr>
            <td><a href="{% url "person-detail" pk=person.linked.id %}">{{ person.linked.fullname }}</a></td>
            <td> {{ person.linked.membership.description }}</td>              
                </tr>
            </table>
        </div>
        <div class="panel-footer">
            <a href="{% url "person-link" pk=person.id %}" class="btn btn-primary btn-sm">Change link</a>
        </div> 
        {% elif children %}
            <table width="300">
                {% for child in children %}
                <tr>
                    <td><a href="{% url "person-detail" pk=child.id %}">{{ child.fullname }}</a></td>
                    <td>{{ child.membership.description }}</td>
                </tr>
                {% endfor child %}
            </table>
        <div class="panel-footer">
            <a href="{% url "person-create" link=person.id %}" class="btn btn-primary btn-sm">Add family member</a>
        </div> 
        {% else %}
           Not part of family
            <div class="panel-footer">
                <a href="{% url "person-link" pk=person.id %}" class="btn btn-primary btn-sm">Link to family</a>
            </div> 
        {% endif %}
       </div>
     </div>
    </div><!--/col-->
  </div>





{% if subs %}
    {% include "members/_subscription_list.html" %}
{% else %}
     <a href="{% url "sub-create" person_id=person.id %}" class="btn btn-primary btn-sm">Add subscription</a>
{% endif %}

{% if statement %}
<h4>Statement of account</h4>
<table id="statement" class="table table-condensed">
    <thead>
    <tr>
        <th></th>
        <th>Date</th>
        <th>Type</th>
        <th>Number</th>
        <th>Detail</th>
        <th class = "text-right">Credit</th>
        <th class = "text-right">Debit</th>
        <th class = "text-right">Balance</th>
    </tr>
    </thead>
{% for line in statement %}
    {% with line.0 as entry %}
    {% with entry|classname as modelclass %}
    {% if modelclass == 'Invoice' %}
        <tr>
        <td><a href="{% url "invoice-detail" entry.id %}" class="btn btn-primary btn-xs">View</a></td>
        <td>{{ entry.update_date|date }}</td>
        <td>Invoice</td>
        <td>{{ entry.id }}</td>
        <td>{{ state_list|get_option:entry.state }}</td>
        <td></td>
        <td class = "text-right">£{{ entry.total }}</td>
        <td class = "text-right">£{{ line.1 }}</td>
        </tr>
    {% elif modelclass == 'Payment' %}
        <tr>
        <td><a href="{% url "payment-detail" entry.id %}" class="btn btn-primary btn-xs">View</a></td>
        <td>{{ entry.update_date|date }}</td>
        <td>Payment</td>
        <td>{{ entry.id }}</td>
        <td>{{ payment_states|get_option:entry.state }}</td>
        <td class = "text-right">£{{ entry.amount }}</td>
        <td></td>  
        <td class = "text-right">£{{ line.1 }}</td>
        </tr>
    {% elif modelclass == 'CreditNote' %}
        <tr>
        <td></td>
        <td>{{ entry.update_date|date }}</td>
        <td>Credit note</td>       
        <td>{{ entry.id }}</td>
        <td>{{ entry.reference }}</td>
        <td class = "text-right">£{{ entry.amount }}</td>
        <td></td>  
        <td class = "text-right">£{{ line.1 }}</td>
        </tr>
    {% endif %}
    {% endwith %}
    {% endwith %}
{% endfor %}
</table>
{% endif %}

{% if items %}
    {% include "members/_invoiceitem_list.html" %}
    <a href="{% url "invoice-generate" pk=person.id %}" class="btn btn-primary">Generate an invoice</a>
{% else %}
    <h4>No uninvoiced items</h4>
{% endif %}
<a href="{% url "item-create" person_id=person.id %}" class="btn btn-primary">Create item</a>

{% endblock %}
{% block scripts %}
<script>
    $(document).ready(function () {
        $('#person').DataTable();
    });
</script>
{% endblock %}


